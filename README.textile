h1. DEVISE / FACEBOOK CONNECTABLE ~ concept version ~

_Devise << Facebook Connect_

h2. What is Devise?

For the elevator pitch, go here:

"http://github.com/plataformatec/devise":http://github.com/plataformatec/devise

h2. What is Devise Facebook Connect?

*Simple:* A very straightforward Facebook Connect authentication/linking with the ease of *Devise* and power of *Facebooker*. If I may say it myself: The easiest way to get an Rails app Facebook Connect:ed. Authentication in Rails should be straightforward, right? Let's build awesome web-apps instead of re-inventing the authentication!

h2. Dependencies

For now...

* "grimen/devise":http://github.com/grimen/devise - Slightly altered version to make Devise more embracing for extensions.
* "facebooker":http://github.com/mmangino/facebooker - Facebook API integration.

h2. Installation

*Gem*

<pre>
  $ sudo gem install devise_facebook_connectable
</pre>

...and in @config/environment.rb@:

<pre>
  config.gem 'devise_facebook_connectable'
</pre>

*Dependencies*

Note: Should be installed automatically with the gem.

<pre>
  $ sudo gem install devise facebooker
</pre>

...and in @config/environment.rb@:

<pre>
  config.gem 'devise'
  config.gem 'facebooker'
</pre>

h2. Setup

*Devise: Setup*

...if you haven't done this already.

<pre>
  $ ./script/generate devise_install
</pre>

See "Devise":http://github.com/grimen/devise documentation for more info on available generators to get started smoothly.

*Facebooker: Setup*

...if you haven't done this already.

<pre>
  $ ./script/generate xd_receiver
</pre>

...and create a @config/facebooker.yml@ (see *Configuration* below for more details).

In @app/views/layouts/application.html.*@, something like:

<pre>
  <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
           "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  
  <!-- Include Facebook XMLNS (XML nammespace). See Facebooker - or Facebook API - documentation. -->
  <html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml">
    <head>
      <title><%= "Devise << Facebook Connect") %></title>
      
      <%= stylesheet_link_tag 'application' %>
      
      <!-- Include Facebook Javascript (with current locale). See Facebooker documentation. -->
      <%= fb_connect_javascript_tag(:lang => ::I18n.locale) %>
      
      <%= javascript_include_tag :defaults %>
    </head>
    <body>
      <!-- Init Facebook Javascript (using jQuery). See Facebooker documentation. -->
      <%= init_fb_connect :XFBML, :js => :jquery %>
      
      <div id="container">
        <%- flash.each do |name, msg| -%>
          <%= content_tag :div, msg, :id => "flash_#{name}" %>
        <%- end -%>
        
        <p><%= link_to 'Home', root_path %></p>
        
        <% if user_signed_in? -%>
          <div id="user_login_box" style="float:right">
            <%= current_user.email %> |
            <%= link_to 'My info', edit_user_path %> |
          </div>
        <% end -%>
        <div style="clear:both"></div>
        
        <%- if show_title? -%>
          <h1><%=h yield(:title) %></h1>
        <%- end -%>
        
        <%= yield %>
      </div>
    </body>
  </html>
</pre>

*Facebook Connectable: Migration*

<pre>
  create_table :users do
    t.facebook_connectable
    
    # Optional: Additional module migration helpers here.
  end
</pre>

...and indexes (optional):

<pre>
  add_index :users, :facebook_uid
</pre>

...and then don't forget: @$ rake db:migrate@.

*Facebook Connectable: Model*

<pre>
  class User < ActiveRecord::Base
    devise :facebook_connectable
    
    # Optional: Additional modules here.
  end
</pre>

h2. Configuration

*Create a Facebook app*

..if you haven't already: "Create Facebook App":http://facebook.com/developers/createapp.php

*@config/facebooker.yml@*

...should look something like this:

<pre>
  defaults: &defaults
    api_key: YOUR_APP_API_KEY
    secret_key: YOUR_APP_SECRET_KEY
    canvas_page_name: YOUR_APP_CANVAS_NAME
    callback_url: http://localhost:3000 # for testing - depends on your Facebook App settings though.
    pretty_errors: true
    set_asset_host_to_callback_url: false
    tunnel:
      public_host_username: 
      public_host: 
      public_port: 4007
      local_port: 3000

  development:
    <<: *defaults

  test: &test
    <<: *defaults

  cucumber:
    <<: *test

  production: &production
    <<: *defaults

  staging:
    <<: *production
</pre>

*I18n*

Connect/login/logout link labels, and Flash error messages can be set using I18n:

<pre>
  en:
    devise:
      sessions:
        facebook_invalid: "Could not login. Invalid account."
        facebook_session_expired: "Could not login. Facebook Connect session expired."
        facebook_login: "Connect"
        facebook_logout: "Logout"
</pre>

h2. Usage

*View:*

...add the connect/login/logout link somewhere:

<pre>
  <%= facebook_link :for => :user %>
</pre>

*DONE!*

<pre>
  $ ./script/server
</pre>

*Note:* If you experience any issues with connecting and/or signing in/out now, then I simply must have forgot something in these instructions. Please file a GitHub-issue in such case! =)

h2. Important

Stuff that you need to be aware of:

* Just to be clear: You need to use the @devise_facebook_connect@-helpers to login/logout, otherwise it won't work.
* If you login a resource using Facebook Connect (with this extension), you need to logout using the the Facebook Connect logout helpers available. If not you will end up being logged into Facebook but not to the account, and vice-versa. Messy. Would be cool with some kind of polling script that logs the user out of Facebook if the account is signed out - but not really needed now; just a bit of common sense and use the helpers and this will not be an issue.

h2. References

*Examples:*

* "Facebooker Showcase":http://facebooker.pjkh.com - not using Devise, but same-same.

*Documentation:*

* "Facebooker RDoc":http://facebooker.rubyforge.org
* "Facebook Connect Wiki":http://wiki.developers.facebook.com/index.php/Connect/Authorization_Websites
* "Facebook Connect Javascript SDK":http://developers.facebook.com/docs/?u=facebook.jslib.FB.Connect

*Similar projects:*

* "authlogic_facebook_connect":http://github.com/kalasjocke/authlogic_facebook_connect

h2. TODO / Known Issues

* *Namespaced Javascript helpers* is a good practice. Not namespaced right now because I was lazy.
* *Facebook Connect view generator* would be neat.
* *I18n messages* seems to be ignored/overridden. Kinda sucks, and not sure how to fix that nicely right now.
* *Specs* would be great. Skipped tests so far as I built this using experimenting as I wasn't sure how Devise and Warden was working - trial-n-error style. Don't have a clue how to spec Facebook Connect stuff though. Would appreciate any help on this.

h2. License

Released under the MIT license.<br />
Copyright (c) 2009 "Jonas Grimfelt":http://github.com/grimen